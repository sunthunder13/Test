{% extends 'app/home.html' %}
{% block content %}
<html>
<head>
  <title>üìä POS Inventory</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --text: #333;
      --card-bg: #fff;
      --navbar-bg: #2c3e50;
      --sidebar-bg: #2c3e50;
      --highlight: #1abc9c;
    }

    body.dark-mode {
      --bg: #1e1e1e;
      --text: #f4f4f4;
      --card-bg: #2c2c2c;
      --navbar-bg: #111;
      --sidebar-bg: #111;
      --highlight: #27ae60;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }

    .navbar {
      background-color: var(--navbar-bg);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 999;
      justify-content: space-between;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .navbar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }

    .toggle-darkmode {
      font-size: 20px;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }

    .container {
      display: flex;
    }

    .sidebar {
      width: 250px;
      background-color: var(--sidebar-bg);
      color: #fff;
      padding: 20px;
      height: 100vh;
      overflow-y: auto;
      position: fixed;
      top: 60px;
      left: 0;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .sidebar p {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      margin: 10px 0;
    }

    .sidebar ul li a {
      color: #fff;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background-color: #34495e;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .sidebar ul li a:hover {
      background-color: var(--highlight);
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: margin-left 0.3s;
      width: 100%;
    }

    .sidebar.hidden ~ .main-content {
      margin-left: 0;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    form input,
    form button {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    form input {
      flex: 1;
      min-width: 150px;
    }

    form button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    form button:hover {
      background-color: #218838;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    table th,
    table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }

    table th {
      background-color: #f4f4f4;
    }

    .edit-btn,
    .save-btn,
    .cancel-btn,
    .delete-btn {
      margin-right: 5px;
      border: none;
      border-radius: 3px;
      padding: 5px 10px;
      cursor: pointer;
      color: white;
    }

    .edit-btn { background-color: #007bff; }
    .save-btn { background-color: #17a2b8; }
    .cancel-btn { background-color: #6c757d; }
    .delete-btn { background-color: #dc3545; }

    .edit-btn:hover { background-color: #0056b3; }
    .save-btn:hover { background-color: #138496; }
    .cancel-btn:hover { background-color: #5a6268; }
    .delete-btn:hover { background-color: #c82333; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-left">
      <button onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <h1>üìä POS Inventory</h1>
    </div>
    <div>
      <span style="margin-right: 16px;">üë§ {{ request.user.username }}</span>
      <button class="toggle-darkmode" onclick="toggleDarkMode()" id="modeBtn">üåô</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar" id="sidebar">
      <h2>üßæ POS SYSTEM</h2>
      <p><i class="fas fa-user-shield"></i> Admin Panel</p>
      <ul>
        <li><a href="{% url 'home' %}"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="{% url 'sales' %}"><i class="fas fa-cash-register"></i> Sales</a></li>
        <li><a href="{% url 'inventory' %}"><i class="fas fa-boxes"></i> Inventory</a></li>
        <li><a href="{% url 'expenses' %}"><i class="fas fa-money-bill-wave"></i> Expenses</a></li>
        <li><a href="{% url 'record' %}"><i class="fas fa-file-alt"></i> Record</a></li>
        <li><a href="../../../../../OneDrive/Desktop/draft/Application/Project/app/templates/app/signin.html"><i class="fas fa-sign-out-alt"></i> Sign Out</a></li>
      </ul>
    </div>

    <main class="main-content" id="main">
      <h1>üì¶ Inventory Records</h1>
      <form id="inventory-form">
        <input type="text" id="product_name" placeholder="Product Name" required>
        <input type="number" id="stock" placeholder="Stock Quantity" required>
        <input type="number" id="price" placeholder="Price" step="0.01" required>
        <button type="submit">Insert</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Product ID</th>
            <th>Product Name</th>
            <th>Stock</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="inventory-table-body"></tbody>
      </table>
    </main>
  </div>

  <script>
  const tableBody = document.getElementById('inventory-table-body');
  const form = document.getElementById('inventory-form');

  async function fetchInventory() {
    const res = await fetch('/inventory/get/');
    const data = await res.json();
    tableBody.innerHTML = '';
    data.forEach(item => addRow(item));
  }

  function addRow(item) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" value="${item.id}" disabled></td>
      <td><input type="text" value="${item.product_name}" disabled></td>
      <td><input type="number" value="${item.stock}" disabled></td>
      <td><input type="number" step="0.01" value="${item.price}" disabled></td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="save-btn" style="display:none;">Save</button>
        <button class="cancel-btn" style="display:none;">Cancel</button>
        <button class="delete-btn">Delete</button>
      </td>
    `;
    const inputs = row.querySelectorAll('input');
    const [editBtn, saveBtn, cancelBtn, deleteBtn] = row.querySelectorAll('button');

    let original = {};
    editBtn.onclick = () => {
      // Only enable product_name, stock, price (not id)
      for (let i = 1; i < inputs.length; i++) {
        original[i] = inputs[i].value;
        inputs[i].disabled = false;
      }
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
    };

    cancelBtn.onclick = () => {
      for (let i = 1; i < inputs.length; i++) {
        inputs[i].value = original[i];
        inputs[i].disabled = true;
      }
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
    };

    saveBtn.onclick = async () => {
      const updated = {
        product_name: inputs[1].value,
        stock: parseInt(inputs[2].value),
        price: parseFloat(inputs[3].value),
      };
      await fetch(`/inventory/update/${item.id}/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updated)
      });
      fetchInventory();
    };

    deleteBtn.onclick = async () => {
      if (confirm('Delete this item?')) {
        await fetch(`/inventory/delete/${item.id}/`, {
          method: 'POST'
        });
        fetchInventory();
      }
    };

    tableBody.appendChild(row);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      product_name: form.product_name.value,
      stock: parseInt(form.stock.value),
      price: parseFloat(form.price.value)
    };
    const res = await fetch('/inventory/add/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    if (res.ok) {
      form.reset();
      fetchInventory();
      alert('Product added!');
    } else {
      // Improved error handling: show backend error message if available
      let msg = 'Failed to add product.';
      try {
        const err = await res.json();
        if (err && err.error) msg += '\n' + err.error;
      } catch {}
      alert(msg);
    }
  });

  fetchInventory()

    function toggleSidebar() {
      sidebar.classList.toggle('hidden');
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      modeBtn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    }

    renderInventory();
  </script>
</body>
</html>
{% endblock %}
